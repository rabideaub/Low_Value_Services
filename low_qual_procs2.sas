/*Updates: 
		 12/01/15: Added the specific versions of most of the low value procedures
		 02/08/16: Added in Rachel's new procedures*/
		 


/***************************************
****************************************
MACRO SET
****************************************
***************************************/
options compress=yes;

%let out = /sch-projects/dua-data-projects/OPTUM/rabideau/Data;
libname out "&out.";

%let syr=2011;
%let eyr=2013;

/*Create a flag for each low-value procedure performed*/
data out.low_value_procs2;
	set out.low_value_build3;

	lv=0;
	lv_s=0;

	neuro=0;
	neuro_s=0;

	diagnostic=0;
	diagnostic_s=0;

	musculo=0;
	musculo_s=0;

	cardio=0;
	cardio_s=0;

	preoperative=0;
	preoperative_s=0;

	if diag1='n/a' then diag1='';
	if diag2='n/a' then diag2='';
	if diag3='n/a' then diag3='';

	if conf_id="" then ed_stay=0;

	array proc[4] proc_cd proc1-proc3;
	do i=1 to dim(proc);

/*****************************************************
Cardiovascular Testing and Procedures
*****************************************************/

/*IVC filters*/
		/*Numerator*/
		if (proc[i] in('75940') & year<2012) | (proc[i] in('37191') & year>=2012) then do;
			lv=lv+1;
			ivc=1;
			cardio=cardio+1;
		end;

		/*Denominator*/
		   lv_den=1;
		   ivc_den=1;
		   cardio_den=1;

		/*Specific Numerator*/
		if (proc[i] in('75940') & year<2012) | (proc[i] in('37191') & year>=2012) then do;
			lv_s=lv_s+1;
			ivc_s=1;
			cardio_s=cardio_s+1;
		end;

		/*Specific Denominator*/
		   lv_den_s=1;
		   ivc_den_s=1;
		   cardio_den_s=1;

/*Coronary Intervention*/
		/*Numerator*/
		if look_back >= 1 then do;
			if ((proc[i] in('92980','92982') & year<=2012) | 
		   	    (proc[i] in('92920','92928','92923','92937','92941','92943') & year>2012)) & 
			((IHD_all=1 & (fst_dt-first_ihd_dt>=(30.4*3))) | (AMI_all=1 & (fst_dt-first_ami_dt>=(30.4*3))))
			   & ed_stay~=1 & ed14~=1 & pos ~in(/*"UNK"*/"23","NONE") then do;	/*Not in Unknown, or Emergency settings*/
				lv=lv+1; 
				coronary=1;
				cardio=cardio+1;
			end;

			/*Denominator*/
			if ((IHD_all=1 & (fst_dt-first_ihd_dt>=(30.4*3))) | (AMI_all=1 & (fst_dt-first_ami_dt>=(30.4*3))))
			   & ed_stay~=1 & ed14~=1 & pos ~in(/*"UNK"*/"23","NONE") then do;	/*Not in Unknown, or Emergency settings*/
			   lv_den=1;
			   coronary_den=1;
			   cardio_den=1;
			end;

			/*Specific Numerator*/
			if ((proc[i] in('92980','92982') & year<2012) | 
		   	    (proc[i] in('92920','92928','92923','92937','92941','92943') & year>=2012)) & 
				(AMI_all=1 & (fst_dt-first_ami_dt>=(30.4*3))) &
				ed_stay~=1 & ed14~=1 & pos ~in(/*"UNK"*/"23","NONE") then do;	/*Not in Unknown, or Emergency settings*/
				lv_s=lv_s+1; 
				coronary_s=1;
				cardio_s=cardio_s+1;
			end;

			/*Specific Denominator*/
			if (AMI_all=1 & (fst_dt-first_ami_dt>=(30.4*3))) & 
			   ed_stay~=1 & ed14~=1 & pos ~in(/*"UNK"*/"23","NONE") then do;	/*Not in Unknown, or Emergency settings*/
			   lv_den_s=1;
			   coronary_den_s=1;
			   cardio_den_s=1;
			end;
		end;

/*Carotid Artery Scan - Asymptomatic*/
		/*Numerator*/
		if look_back >= 1 then do;
			if proc[i] in('36222','36223','36224','70498','70547','70548','70549','93880','93882','3100F') & stroke_TIA~=1 & 

				(diag1   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag1,1,3)~='781' &
			     diag2   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag2,1,3)~='781' &
			     diag3   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag3,1,3)~='781') 
			then do;
				lv=lv+1;
				carotid_scan_asymp=1;
				cardio=cardio+1;
			end;

			/*Denominator*/
			if stroke_TIA~=1 & 
				(diag1   ~in('430','431','43301','43311','43321','43331','43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag1,1,3)~='781' &
			     diag2   ~in('430','431','43301','43311','43321','43331','43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag2,1,3)~='781' &
			     diag3   ~in('430','431','43301','43311','43321','43331','43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag3,1,3)~='781') 
			then do;
			   lv_den=1;
			   carotid_scan_asymp_den=1;
			   cardio_den=1;
			end;

			/*Specific Numerator*/
			if proc[i] in('36222','36223','36224','70498','70547','70548','70549','93880','93882','3100F') & stroke_TIA~=1 & 

				(diag1   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag1,1,3)~='781' &
			     diag2   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag2,1,3)~='781' &
			     diag3   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag3,1,3)~='781') &
				 pos ~in(/*"UNK"*/"21","23","NONE") & ed_stay~=1 & ed14~=1  then do;									/*Not in Unknown, Inpatient, or Emergency settings*/

				lv_s=lv_s+1;
				carotid_scan_asymp_s=1;
				cardio_s=cardio_s+1;
			end;

			/*Specific Denominator*/
			if (diag1    ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag1,1,3)~='781' &
			     diag2   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag2,1,3)~='781' &
			     diag3   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag3,1,3)~='781') &
				 pos ~in(/*"UNK"*/"21","23","NONE") & ed_stay~=1 & ed14~=1  then do;									/*Not in Unknown, Inpatient, or Emergency settings*/

			   lv_den_s=1;
			   carotid_scan_asymp_den_s=1;
			   cardio_den_s=1;
			end;
		end;

/*Carotid Artery Scan - Syncope*/
		/*Numerator*/
		if proc[i]   in('36222','36223','36224','70498','70547','70548','70549','93880','93882','3100F') & 
			(diag1   in('7802','9921') |
		     diag2   in('7802','9921') |
		     diag3   in('7802','9921')) then do;

			lv=lv+1;
			carotid_scan_sync=1;
			cardio=cardio+1;
		end;

		/*Denominator*/
		if 	(diag1   in('7802','9921') |
		     diag2   in('7802','9921') |
		     diag3 in('7802','9921')) then do;

		   lv_den=1;
		   carotid_scan_sync_den=1;
		   cardio_den=1;
		end;

		/*Specific Numerator*/
		if look_back >= 1 then do;
			if proc[i] in('36222','36223','36224','70498','70547','70548','70549','93880','93882','3100F') & stroke_TIA~=1 & /*Screening, no stroke-TIA history*/

				(diag1   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401', /*No stroke, TIA, or neurological symptoms*/
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','781xx','7820','78451','78452','78459') & substr(diag1,1,3)~='781' &
			     diag2   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','781xx','7820','78451','78452','78459') & substr(diag2,1,3)~='781' &
			     diag3   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','781xx','7820','78451','78452','78459') & substr(diag3,1,3)~='781') &

				(diag1   in('7802','9921') | /*With diagnosis of syncope*/
			     diag2   in('7802','9921') |
			     diag3 in('7802','9921')) then do;

				lv_s=lv_s+1;
				carotid_scan_sync_s=1;
				cardio_s=cardio_s+1;
			end;

			/*Specific Denominator*/
			if stroke_TIA~=1 & /*Screening, no stroke-TIA history*/

				(diag1   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401', /*No stroke, TIA, or neurological symptoms*/
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','781xx','7820','78451','78452','78459') & substr(diag1,1,3)~='781' &
			     diag2   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','781xx','7820','78451','78452','78459') & substr(diag2,1,3)~='781' &
			     diag3   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','781xx','7820','78451','78452','78459') & substr(diag3,1,3)~='781') &

				(diag1   in('7802','9921') | /*With diagnosis of syncope*/
			     diag2   in('7802','9921') |
			     diag3 in('7802','9921')) then do;

			   lv_den_s=1;
			   carotid_scan_sync_den_s=1;
			   cardio_den_s=1;
			end;
		end;

/*Stress Testing*/
		/*Numerator*/
		if look_back >= 1 then do;
			if proc[i] in('93015','93016','93017','93018','93350','93351','78451','78452','78453','78454',
						 '78460','78461','78464','78465','78472','78473','78481','78483','78491','78492') & 
			   ((IHD_all=1 & (fst_dt-first_ihd_dt>=(30.4*3))) | (AMI_all=1 & (fst_dt-first_ami_dt>=(30.4*3)))) then do;
				lv=lv+1;
				cardio_stress=1;
				cardio=cardio+1;
			end;

			/*Denominator*/
			if ((IHD_all=1 & (fst_dt-first_ihd_dt>=(30.4*3))) | (AMI_all=1 & (fst_dt-first_ami_dt>=(30.4*3)))) then do;
			   lv_den=1;
			   cardio_stress_den=1;
			   cardio_den=1;
			end;

			/*Specific Numerator*/
			if proc[i] in('93015','93016','93017','93018','93350','93351','78451','78452','78453','78454',
						 '78460','78461','78464','78465','78472','78473','78481','78483','78491','78492') 
			   & (AMI_all=1 & (fst_dt-first_ami_dt>=(30.4*3))) & /*Must have IHD and past AMI*/

				ed_stay~=1 & ed14~=1 & pos ~in(/*"UNK"*/"21","23","NONE")  then do;	/*Not in Unknown, Inpatient, or Emergency settings*/

				lv_s=lv_s+1;
				cardio_stress_s=1;
				cardio_s=cardio_s+1;
			end;

			/*Specific Denominator*/
			if (AMI_all=1 & (fst_dt-first_ami_dt>=(30.4*3))) & /*Must have IHD and past AMI*/
			   ed_stay~=1 & ed14~=1 & pos ~in(/*"UNK"*/"21","23","NONE")  then do;	/*Not in Unknown, Inpatient, or Emergency settings*/

			   lv_den_s=1;
			   cardio_stress_den_s=1;
			   cardio_den_s=1;
			end;
		end;

/*Renal Artery Angioplasy*/
	/*Numerator*/
		if proc[i] in('35471','35450','37205','37207','75966','75960') then do;
			lv=lv+1;
			renal_angio=1;
			cardio=cardio+1;
		end;

		/*Denominator*/
		   lv_den=1;
		   renal_angio_den=1;
		   cardio_den=1;

		/*Specific Numerator*/
		if proc[i] in('35471','35450','37205','37207','75966','75960') & 
		   (diag1 in('4401','40501','40511','40591') |
		    diag2 in('4401','40501','40511','40591') |
		    diag3 in('4401','40501','40511','40591')) then do;

			lv_s=lv_s+1;
			renal_angio_s=1;
			cardio_s=cardio_s+1;
		end;

		/*Specific Denominator*/
		if (diag1 in('4401','40501','40511','40591') |
		    diag2 in('4401','40501','40511','40591') |
		    diag3 in('4401','40501','40511','40591')) then do;

		   lv_den_s=1;
		   renal_angio_den_s=1;
		   cardio_den_s=1;
		end;
	
/*Carotid Endarterectomy*/
		/*Numerator*/
		if look_back >= 1 then do;
			if proc[i] in('35301') & stroke_TIA~=1 & 

				(diag1   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag1,1,3)~='781' &
			     diag2   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag2,1,3)~='781' &
			     diag3 ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag3,1,3)~='781') 
			then do;
				lv=lv+1;
				carotid_end=1;
				cardio=cardio+1;
			end;

			/*Denominator*/
			if stroke_TIA~=1 & 

				(diag1   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag1,1,3)~='781' &
			     diag2   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag2,1,3)~='781' &
			     diag3 ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag3,1,3)~='781') 
			then do;
			   lv_den=1;
			   carotid_end_den=1;
			   cardio_den=1;
			end;

			/*Specific Numerator*/
			if proc[i] in('35301') & stroke_TIA~=1 & upcase(gdr_cd)='F' & ed14~=1 & /*Females only*/

				pos ~in(/*"UNK"*/"23","NONE") & ed_stay~=1 & ed14~=1 &	/*Not in Unknown, or Emergency settings*/

				(diag1   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag1,1,3)~='781' &
			     diag2   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag2,1,3)~='781' &
			     diag3 ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag3,1,3)~='781') 
			then do;
				lv_s=lv_s+1;
				carotid_end_s=1;
				cardio_s=cardio_s+1;
			end;

			/*Specific Denominator*/
			if stroke_TIA~=1 & upcase(gdr_cd)='F' & ed14~=1 &  /*Females only*/

				pos ~in(/*"UNK"*/"23","NONE") & ed_stay~=1 & ed14~=1 &   /*Not in Unknown, or Emergency settings*/

				(diag1   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag1,1,3)~='781' &
			     diag2   ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag2,1,3)~='781' &
			     diag3 ~in('430','431','43301','43311','43321','43331	43381','43391','43400','43401',
							 '43410','43411	43490','43491','4350','4351','4353','4358','4359','436','99702',
							 'V1254','3623','36284','7802','781xx','7820','78451','78452','78459') & substr(diag3,1,3)~='781') 
			then do;
			   lv_den_s=1;
			   carotid_end_den_s=1;
			   cardio_den_s=1;
			end;
		end;
/*****************************************************
 Head and Neurologic Diagnostic Imaging and Testing
*****************************************************/

/*CT Sinuses*/
		/*Numerator*/
		if proc[i] in('70486','70487','70488') & 
		   (substr(diag1,1,3) in('461','473') | 
		    substr(diag2,1,3) in('461','473') |
		    substr(diag3,1,3) in('461','473')) then do;

			lv=lv+1;
			ct_sinus=1;
			neuro=neuro+1;
		end;

		/*Denominator*/
		if (substr(diag1,1,3) in('461','473') |
		    substr(diag2,1,3) in('461','473') |
		    substr(diag3,1,3) in('461','473')) then do;
			lv_den=1;
			ct_sinus_den=1;
			neuro_den=1;
		end;

		/*Specific Numerator*/
		if look_back >= 1 then do;
			if proc[i] in('70486','70487','70488') & 

			   (substr(diag1,1,3) in('461','473') | substr(diag2,1,3) in('461','473') | substr(diag3,1,3) in('461','473')) & 

			   sinusitis=0 & /*No chronic sinusitis*/

			   substr(diag1,1,3) ~in('471','373','800','801','802','803','804','850','851','852','853',
									 '854','870','871','872','873','910','920','921','042','279') &
			   substr(diag1,1,4) ~in('2770','9590') & diag1 ~in('07953','37600') &

			   substr(diag2,1,3) ~in('471','373','800','801','802','803','804','850','851','852','853',
									 '854','870','871','872','873','910','920','921','042','279') &
			   substr(diag2,1,4) ~in('2770','9590') & diag2 ~in('07953','37600') &

			   substr(diag3,1,3) ~in('471','373','800','801','802','803','804','850','851','852','853',
									 '854','870','871','872','873','910','920','921','042','279') &
			   substr(diag3,1,4) ~in('2770','9590') & diag3 ~in('07953','37600') then do;

				lv_s=lv_s+1;
				ct_sinus_s=1;
				neuro_s=neuro_s+1;
			end;

			/*Specific Denominator*/
			if (substr(diag1,1,3) in('461','473') | substr(diag2,1,3) in('461','473') | substr(diag3,1,3) in('461','473')) & 

			   sinusitis=0 & /*No chronic sinusitis*/

			   substr(diag1,1,3) ~in('471','373','800','801','802','803','804','850','851','852','853',
									 '854','870','871','872','873','910','920','921','042','279') &
			   substr(diag1,1,4) ~in('2770','9590') & diag1 ~in('07953','37600') &

			   substr(diag2,1,3) ~in('471','373','800','801','802','803','804','850','851','852','853',
									 '854','870','871','872','873','910','920','921','042','279') &
			   substr(diag2,1,4) ~in('2770','9590') & diag2 ~in('07953','37600') &

			   substr(diag3,1,3) ~in('471','373','800','801','802','803','804','850','851','852','853',
									 '854','870','871','872','873','910','920','921','042','279') &
			   substr(diag3,1,4) ~in('2770','9590') & diag3 ~in('07953','37600') then do;

				lv_den_s=1;
				ct_sinus_den_s=1;
				neuro_den_s=1;
			end;
		end;
 
/*Head Scan Syncope*/
		/*Numerator*/
		if proc[i] in('70450','70460','70470','70551','70552','70553') &
			(diag1 in('7802','9921') |
		     diag2 in('7802','9921') |
		     diag3 in('7802','9921')) then do;

			lv=lv+1;
			scan_sync=1;
			neuro=neuro+1;
		end;

		/*Denominator*/
		if	(diag1 in('7802','9921') |
		     diag2 in('7802','9921') |
		     diag3 in('7802','9921')) then do;
			lv_den=1;
			scan_sync_den=1;
			neuro_den=1;
		end;

		/*Specific Numerator*/
		if proc[i] in('70450','70460','70470','70551','70552','70553') & /*Headscan*/

			(diag1 in('7802','9921') |	/*For syncope*/
		     diag2 in('7802','9921') |
		     diag3 in('7802','9921')) &

			((diag1 ~in('78097','7820','V1254') & substr(diag1,1,3) ~in('345','800','801','802','803','804','850','851', /*No other warranting claim*/
				'852','853','854','870','871','872','873','910','920','921','781','V10') & substr(diag1,1,4) ~in('7803','7845',
				'9590') & substr(diag1,1,2) ~in('43')) &
			 (diag2 ~in('78097','7820','V1254') & substr(diag2,1,3) ~in('345','800','801','802','803','804','850','851',
				'852','853','854','870','871','872','873','910','920','921','781','V10') & substr(diag2,1,4) ~in('7803','7845',
				'9590') & substr(diag2,1,2) ~in('43')) &
			 (diag3 ~in('78097','7820','V1254') & substr(diag3,1,3) ~in('345','800','801','802','803','804','850','851',
				'852','853','854','870','871','872','873','910','920','921','781','V10') & substr(diag3,1,4) ~in('7803','7845',
				'9590') & substr(diag3,1,2) ~in('43'))) then do;

			lv_s=lv_s+1;
			scan_sync_s=1;
			neuro_s=neuro_s+1;
		end;

		/*Specific Denominator*/
		if	(diag1 in('7802','9921') |	/*For syncope*/
		     diag2 in('7802','9921') |
		     diag3 in('7802','9921')) &

			((diag1 ~in('78097','7820','V1254') & substr(diag1,1,3) ~in('345','800','801','802','803','804','850','851', /*No other warranting claim*/
				'852','853','854','870','871','872','873','910','920','921','781','V10') & substr(diag1,1,4) ~in('7803','7845',
				'9590') & substr(diag1,1,2) ~in('43')) &
			 (diag2 ~in('78097','7820','V1254') & substr(diag2,1,3) ~in('345','800','801','802','803','804','850','851',
				'852','853','854','870','871','872','873','910','920','921','781','V10') & substr(diag2,1,4) ~in('7803','7845',
				'9590') & substr(diag2,1,2) ~in('43')) &
			 (diag3 ~in('78097','7820','V1254') & substr(diag3,1,3) ~in('345','800','801','802','803','804','850','851',
				'852','853','854','870','871','872','873','910','920','921','781','V10') & substr(diag3,1,4) ~in('7803','7845',
				'9590') & substr(diag3,1,2) ~in('43'))) then do;

			lv_den_s=1;
			scan_sync_den_s=1;
			neuro_den_s=1;
		end;

/*Head Scan Headache*/
		/*Numerator*/
		if proc[i] in('70450','70460','70470','70551','70552','70553') & 

			(diag1 in('30781','339xx','364x','7840') | substr(diag1,1,3) in('339','364') |
		     diag2 in('30781','339xx','364x','7840') | substr(diag2,1,3) in('339','364') |
		     diag3 in('30781','339xx','364x','7840') | substr(diag3,1,3) in('339','364')) &
			/*DX must be at least one of the above, none of the below*/
			(diag1   ~in('33920','33921','33922','33943') &
		     diag2   ~in('33920','33921','33922','33943') &
		     diag3 ~in('33920','33921','33922','33943')) then do;

			lv=lv+1;
			scan_head=1;
			neuro=neuro+1;
		end;

		/*Denominator*/
		if (diag1 in('30781','339xx','364x','7840') | substr(diag1,1,3) in('339','364') |
		    diag2 in('30781','339xx','364x','7840') | substr(diag2,1,3) in('339','364') |
		    diag3 in('30781','339xx','364x','7840') | substr(diag3,1,3) in('339','364')) &
			/*DX must be at least one of the above, none of the below*/
		   (diag1   ~in('33920','33921','33922','33943') &
		    diag2   ~in('33920','33921','33922','33943') &
		    diag3 ~in('33920','33921','33922','33943')) then do;

			lv_den=1;
			scan_head_den=1;
			neuro_den=1;
		end;

		/*Specific Numerator*/
		if proc[i] in('70450','70460','70470','70551','70552','70553') & /*Headscan*/

			(diag1 in('30781','339xx','364x','7840') | substr(diag1,1,3) in('339','364') | /*With uncomplicated headache*/
		     diag2 in('30781','339xx','364x','7840') | substr(diag2,1,3) in('339','364') |
		     diag3 in('30781','339xx','364x','7840') | substr(diag3,1,3) in('339','364')) &

			/*DX must be at least one of the above, none of the below*/
			((diag1 ~in('33920','33921','33922','33943','4465','78097','V1254') & substr(diag1,1,3) ~in('345','800','801', /*No other warranting claims*/
				'802','803','804','850','851','852','853','854','870','871','872','873','781','V10') & 					  
				substr(diag1,1,4) ~in('3463','3466','7803','7845','9590') & substr(diag1,1,2) ~in('43') & 
				~((140<=input(substr(diag1,1,3),?? 3.)<=208) | (230<=input(substr(diag1,1,3),?? 3.)<=239))) &    /*140xx-208xx and 230xx-239xx are cancer codes*/
			 (diag2 ~in('33920','33921','33922','33943','4465','78097','V1254') & substr(diag2,1,3) ~in('345','800','801',
				'802','803','804','850','851','852','853','854','870','871','872','873','781','V10') &
				substr(diag2,1,4) ~in('3463','3466','7803','7845','9590') & substr(diag2,1,2) ~in('43') & 
				~((140<=input(substr(diag2,1,3),?? 3.)<=208) | (230<=input(substr(diag2,1,3),?? 3.)<=239))) & 
			 (diag3 ~in('33920','33921','33922','33943','4465','78097','V1254') & substr(diag3,1,3) ~in('345','800','801',
				'802','803','804','850','851','852','853','854','870','871','872','873','781','V10') &
				substr(diag3,1,4) ~in('3463','3466','7803','7845','9590') & substr(diag3,1,2) ~in('43') & 
				~((140<=input(substr(diag3,1,3),?? 3.)<=208) | (230<=input(substr(diag3,1,3),?? 3.)<=239)))) then do;

			lv_s=lv_s+1;
			scan_head_s=1;
			neuro_s=neuro_s+1;
		end;

		/*Specific Denominator*/
		if	(diag1 in('30781','339xx','364x','7840') | substr(diag1,1,3) in('339','364') | /*With headache*/
		     diag2 in('30781','339xx','364x','7840') | substr(diag2,1,3) in('339','364') |
		     diag3 in('30781','339xx','364x','7840') | substr(diag3,1,3) in('339','364')) &

			/*DX must be at least one of the above, none of the below*/
			((diag1 ~in('33920','33921','33922','33943','4465','78097','V1254') & substr(diag1,1,3) ~in('345','800','801', /*No other warranting claims*/
				'802','803','804','850','851','852','853','854','870','871','872','873','781','V10') & 					  
				substr(diag1,1,4) ~in('3463','3466','7803','7845','9590') & substr(diag1,1,2) ~in('43') & 
				~((140<=input(substr(diag1,1,3),?? 3.)<=208) | (230<=input(substr(diag1,1,3),?? 3.)<=239))) &    /*140xx-208xx and 230xx-239xx are cancer codes*/
			 (diag2 ~in('33920','33921','33922','33943','4465','78097','V1254') & substr(diag2,1,3) ~in('345','800','801',
				'802','803','804','850','851','852','853','854','870','871','872','873','781','V10') &
				substr(diag2,1,4) ~in('3463','3466','7803','7845','9590') & substr(diag2,1,2) ~in('43') & 
				~((140<=input(substr(diag2,1,3),?? 3.)<=208) | (230<=input(substr(diag2,1,3),?? 3.)<=239))) & 
			 (diag3 ~in('33920','33921','33922','33943','4465','78097','V1254') & substr(diag3,1,3) ~in('345','800','801',
				'802','803','804','850','851','852','853','854','870','871','872','873','781','V10') &
				substr(diag3,1,4) ~in('3463','3466','7803','7845','9590') & substr(diag3,1,2) ~in('43') & 
				~((140<=input(substr(diag3,1,3),?? 3.)<=208) | (230<=input(substr(diag3,1,3),?? 3.)<=239)))) then do;

			lv_den_s=1;
			scan_head_den_s=1;
			neuro_den_s=1;
		end;

/*EEG Headache*/
		/*Numerator*/
		if proc[i] in('95812','95813','95816','95819','95822','95827','95830','95957') &
			(diag1   in('30781','339xx','346x','7840') | substr(diag1,1,3) in('339','346') |
		     diag2   in('30781','339xx','346x','7840') | substr(diag2,1,3) in('339','346') |
		     diag3 in('30781','339xx','346x','7840') | substr(diag3,1,3) in('339','346')) then do;

			lv=lv+1;
			eeg_head=1;
			neuro=neuro+1;
		end;

		/*Denominator*/
		if (diag1   in('30781','339xx','346x','7840') | substr(diag1,1,3) in('339','346') |
		    diag2   in('30781','339xx','346x','7840') | substr(diag2,1,3) in('339','346') |
		    diag3 in('30781','339xx','346x','7840') | substr(diag3,1,3) in('339','346')) then do;

		   lv_den=1;
		   eeg_head_den=1;
		   neuro_den=1;
		end;

		/*Specific Numerator*/
		if look_back >= 1 then do;
			if proc[i] in('95812','95813','95816','95819','95822','95827','95830','95957')   &
				(diag1 in('30781','339xx','346x','7840') | substr(diag1,1,3) in('339','346') |
			     diag2 in('30781','339xx','346x','7840') | substr(diag2,1,3) in('339','346') |
			     diag3 in('30781','339xx','346x','7840') | substr(diag3,1,3) in('339','346')) &
			   epilepsy=0 then do;

				lv_s=lv_s+1;
				eeg_head_s=1;
				neuro_s=neuro_s+1;
			end;

			/*Specific Denominator*/
			if (diag1 in('30781','339xx','346x','7840') | substr(diag1,1,3) in('339','346') |
			    diag2 in('30781','339xx','346x','7840') | substr(diag2,1,3) in('339','346') |
			    diag3 in('30781','339xx','346x','7840') | substr(diag3,1,3) in('339','346')) &
				epilepsy=0 then do;

			   lv_den_s=1;
			   eeg_head_den_s=1;
			   neuro_den_s=1;
			end;
		end;

/*****************************************************
 Musculoskeletal Diagnostic Testing and Procedures
*****************************************************/

/*Bone Density*/
	if look_back >= 2 then do;
		/*Numerator*/
		if proc[i] in('76977','77078','77079','77080','77083','78350','78351') & prebone>=2 then do;
			lv=lv+1;
			lv_bone=1;
			musculo=musculo+1;
		end;

		/*Denominator*/
		if prebone=1 then do;
			lv_den=1;
			lv_bone_den=1;
			musculo_den=1;
		end;
			/*Specific test: only with osteoporosis before initial test*/

		/*Specific Numerator*/
		if proc[i] in('76977','77078','77079','77080','77083','78350','78351') & prebone>=2 & ost=1 then do;
			lv_s=lv_s+1;
			lv_bone_s=1;
			musculo_s=musculo_s+1;
		end;

		/*Specific Denominator*/
		if prebone>=1 & ost=1 then do;
			lv_den_s=1;
			lv_bone_den_s=1;
			musculo_den_s=1;
		end;
	end;

/*Back Scan*/
		/*Numerator*/
		if proc[i] in('72010','72020','72052','72100','72110','72114','72120','72200', /*Back Scan Procedure Performed*/
					 '72202','72220','72131','72132','72133','72141','72142','72146',
					 '72147','72148','72149','72156','72157','72158') & 

			(diag1   in('7213','72190','72210','72252','7226','72293','72402','7242',  /*With a Diagnosis of Back Pain*/
						'7243','7244','7245','7246','72470','72471','72479','7385',
						'7393','7394','8460','8461','8462','8463','8468','8469','8472') |
		     diag2   in('7213','72190','72210','72252','7226','72293','72402','7242',
						'7243','7244','7245','7246','72470','72471','72479','7385',
						'7393','7394','8460','8461','8462','8463','8468','8469','8472') |
		     diag3   in('7213','72190','72210','72252','7226','72293','72402','7242',
						'7243','7244','7245','7246','72470','72471','72479','7385',
						'7393','7394','8460','8461','8462','8463','8468','8469','8472')) then do;

			lv=lv+1;
			back=1;
			musculo=musculo+1;
		end;

		/*Denominator*/
		if	(diag1   in('7213','72190','72210','72252','7226','72293','72402','7242',  /*With a Diagnosis of Back Pain*/
						'7243','7244','7245','7246','72470','72471','72479','7385',
						'7393','7394','8460','8461','8462','8463','8468','8469','8472') |
		     diag2   in('7213','72190','72210','72252','7226','72293','72402','7242',
						'7243','7244','7245','7246','72470','72471','72479','7385',
						'7393','7394','8460','8461','8462','8463','8468','8469','8472') |
		     diag3   in('7213','72190','72210','72252','7226','72293','72402','7242',
						'7243','7244','7245','7246','72470','72471','72479','7385',
						'7393','7394','8460','8461','8462','8463','8468','8469','8472')) then do;

		   lv_den=1;
		   back_den=1;
		   musculo_den=1;
		end;

		/*Specific Numerator*/
		if look_back >= 1 then do;
			if proc[i] in('72010','72020','72052','72100','72110','72114','72120','72200', /*Back Scan Procedure Performed*/
						 '72202','72220','72131','72132','72133','72141','72142','72146',
						 '72147','72148','72149','72156','72157','72158') & 

				(diag1 in('7213','72190','72210','72252','7226','72293','72402','7242',   /*With a Diagnosis of Back Pain*/
						  '7243','7244','7245','7246','72470','72471','72479','7385',
						  '7393','7394','8460','8461','8462','8463','8468','8469','8472') |
			     diag2 in('7213','72190','72210','72252','7226','72293','72402','7242',
						  '7243','7244','7245','7246','72470','72471','72479','7385',
						  '7393','7394','8460','8461','8462','8463','8468','8469','8472') |
			     diag3 in('7213','72190','72210','72252','7226','72293','72402','7242',
						  '7243','7244','7245','7246','72470','72471','72479','7385',
						  '7393','7394','8460','8461','8462','8463','8468','8469','8472')) &

				Fst_dt-bp_dt <= 42 &	/*Within 6 weeks of the first diagnosis of back pain. bp_dt is the first observable pain dx, not most recent*/

				substr(diag1,1,2) ~in('01','86') & 		/*Without any of the following warranting diagnoses*/
				substr(diag1,1,3) ~in('952','958','959','038','730','929') &
				substr(diag1,1,4) ~in('7292','7830','7832','7808','2859') &
				diag1 ~in('92611','92612','304460','4210','4211','4219','78079') & 
				~((140<=(input(substr(diag1,1,3),?? 3.))<=208) | (230<=(input(substr(diag1,1,3),?? 3.))<=239) | 
				  (850<=(input(substr(diag1,1,3),?? 3.))<=854) | (800<=(input(substr(diag1,1,3),?? 3.))<=839) | 
				  (905<=(input(substr(diag1,1,3),?? 3.))<=909) | (3054<=(input(substr(diag1,1,4),?? 4.))<=3057) |
				  (3040<=(input(substr(diag1,1,4),?? 4.))<=3042)) &

				substr(diag2,1,2) ~in('01','86') &
				substr(diag2,1,3) ~in('952','958','959','038','730','929') &
				substr(diag2,1,4) ~in('7292','7830','7832','7808','2859') &
				diag2 ~in('92611','92612','304460','4210','4211','4219','78079') & 
				~((140<=(input(substr(diag2,1,3),?? 3.))<=208) | (230<=(input(substr(diag2,1,3),?? 3.))<=239) | 
				  (850<=(input(substr(diag2,1,3),?? 3.))<=854) | (800<=(input(substr(diag2,1,3),?? 3.))<=839) | 
				  (905<=(input(substr(diag2,1,3),?? 3.))<=909) | (3054<=(input(substr(diag2,1,4),?? 4.))<=3057) |
				  (3040<=(input(substr(diag2,1,4),?? 4.))<=3042)) &

				substr(diag3,1,2) ~in('01','86') &
				substr(diag3,1,3) ~in('952','958','959','038','730','929') &
				substr(diag3,1,4) ~in('7292','7830','7832','7808','2859') &
				diag3 ~in('92611','92612','304460','4210','4211','4219','78079') & 
				~((140<=(input(substr(diag3,1,3),?? 3.))<=208) | (230<=(input(substr(diag3,1,3),?? 3.))<=239) | 
				  (850<=(input(substr(diag3,1,3),?? 3.))<=854) | (800<=(input(substr(diag3,1,3),?? 3.))<=839) | 
				  (905<=(input(substr(diag3,1,3),?? 3.))<=909) | (3054<=(input(substr(diag3,1,4),?? 4.))<=3057) |
				  (3040<=(input(substr(diag3,1,4),?? 4.))<=3042)) then do;

				lv_s=lv_s+1;
				back_s=1;
				musculo_s=musculo_s+1;
			end;

			/*Specific Denominator*/
			if	(diag1 in('7213','72190','72210','72252','7226','72293','72402','7242',   /*With a Diagnosis of Back Pain*/
						  '7243','7244','7245','7246','72470','72471','72479','7385',
						  '7393','7394','8460','8461','8462','8463','8468','8469','8472') |
			     diag2 in('7213','72190','72210','72252','7226','72293','72402','7242',
						  '7243','7244','7245','7246','72470','72471','72479','7385',
						  '7393','7394','8460','8461','8462','8463','8468','8469','8472') |
			     diag3 in('7213','72190','72210','72252','7226','72293','72402','7242',
						  '7243','7244','7245','7246','72470','72471','72479','7385',
						  '7393','7394','8460','8461','8462','8463','8468','8469','8472')) &

				Fst_dt-bp_dt <= 42 &	/*Within 6 weeks of the first diagnosis of back pain. bp_dt is the first observable pain dx, not most recent*/

				substr(diag1,1,2) ~in('01','86') & 		/*Without any of the following warranting diagnoses*/
				substr(diag1,1,3) ~in('952','958','959','038','730','929') &
				substr(diag1,1,4) ~in('7292','7830','7832','7808','2859') &
				diag1 ~in('92611','92612','304460','4210','4211','4219','78079') & 
				~((140<=(input(substr(diag1,1,3),?? 3.))<=208) | (230<=(input(substr(diag1,1,3),?? 3.))<=239) | 
				  (850<=(input(substr(diag1,1,3),?? 3.))<=854) | (800<=(input(substr(diag1,1,3),?? 3.))<=839) | 
				  (905<=(input(substr(diag1,1,3),?? 3.))<=909) | (3054<=(input(substr(diag1,1,4),?? 4.))<=3057) |
				  (3040<=(input(substr(diag1,1,4),?? 4.))<=3042)) &

				substr(diag2,1,2) ~in('01','86') &
				substr(diag2,1,3) ~in('952','958','959','038','730','929') &
				substr(diag2,1,4) ~in('7292','7830','7832','7808','2859') &
				diag2 ~in('92611','92612','304460','4210','4211','4219','78079') & 
				~((140<=(input(substr(diag2,1,3),?? 3.))<=208) | (230<=(input(substr(diag2,1,3),?? 3.))<=239) | 
				  (850<=(input(substr(diag2,1,3),?? 3.))<=854) | (800<=(input(substr(diag2,1,3),?? 3.))<=839) | 
				  (905<=(input(substr(diag2,1,3),?? 3.))<=909) | (3054<=(input(substr(diag2,1,4),?? 4.))<=3057) |
				  (3040<=(input(substr(diag2,1,4),?? 4.))<=3042)) &

				substr(diag3,1,2) ~in('01','86') &
				substr(diag3,1,3) ~in('952','958','959','038','730','929') &
				substr(diag3,1,4) ~in('7292','7830','7832','7808','2859') &
				diag3 ~in('92611','92612','304460','4210','4211','4219','78079') & 
				~((140<=(input(substr(diag3,1,3),?? 3.))<=208) | (230<=(input(substr(diag3,1,3),?? 3.))<=239) | 
				  (850<=(input(substr(diag3,1,3),?? 3.))<=854) | (800<=(input(substr(diag3,1,3),?? 3.))<=839) | 
				  (905<=(input(substr(diag3,1,3),?? 3.))<=909) | (3054<=(input(substr(diag3,1,4),?? 4.))<=3057) |
				  (3040<=(input(substr(diag3,1,4),?? 4.))<=3042)) then do;

			   lv_den_s=1;
			   back_den_s=1;
			   musculo_den_s=1;
			end;
		end;

/*Spinal injections for low back pain*/
		/*Numerator*/
		if proc[i] in ('62311','64483', '20552','20553','64493', '64475'/*,'J1438'*/) &
		(diag1 in ('7213', '72190', '72210','7222', '72252', '7226', 
				  '72280','72283', '72293', '72400', '72402','72403','7242', '7245',  '7246', '72470','72471', '72479',
				  '7384', '7385',  '7393',  '7384',  '7385', '7393', '7394', '75612', '8460', '8461', '8462',  '8463', 
				  '8468', '8469',  '8472') | /*Indicates presence of back pain*/
		diag2 in ('7213', '72190', '72210','7222', '72252', '7226', 
				  '72280','72283', '72293', '72400', '72402','72403','7242', '7245',  '7246', '72470','72471', '72479',
				  '7384', '7385',  '7393',  '7384',  '7385', '7393', '7394', '75612', '8460', '8461', '8462',  '8463', 
				  '8468', '8469',  '8472') |
		diag3 in ('7213', '72190', '72210','7222', '72252', '7226', 
				  '72280','72283', '72293', '72400', '72402','72403','7242', '7245',  '7246', '72470','72471', '72479',
				  '7384', '7385',  '7393',  '7384',  '7385', '7393', '7394', '75612', '8460', '8461', '8462',  '8463', 
				  '8468', '8469',  '8472')) &
		diag1 ~in('72142','72191', '72270', '72273', '7243', '7244') & /*Exclusion of radicular back pain*/
		diag2 ~in('72142','72191', '72270', '72273', '7243', '7244') &
		diag3 ~in('72142','72191', '72270', '72273', '7243', '7244') &
		pos in('11','22') then do; /*Only Office or Outpatient Hospitals*/
			lv=lv+1;
			spine_inj=1;
			musculo=musculo+1;
			lv_s=lv_s+1;
			spine_inj_s=1;
			musculo_s=musculo_s+1;
		end;

		/*Denominator*/
		if 	(diag1 in ('7213', '72190', '72210','7222', '72252', '7226', 
					  '72280','72283', '72293', '72400', '72402','72403','7242', '7245',  '7246', '72470','72471', '72479',
					  '7384', '7385',  '7393',  '7384',  '7385', '7393', '7394', '75612', '8460', '8461', '8462',  '8463', 
					  '8468', '8469',  '8472') | /*Indicates presence of back pain*/
			diag2 in ('7213', '72190', '72210','7222', '72252', '7226', 
					  '72280','72283', '72293', '72400', '72402','72403','7242', '7245',  '7246', '72470','72471', '72479',
					  '7384', '7385',  '7393',  '7384',  '7385', '7393', '7394', '75612', '8460', '8461', '8462',  '8463', 
					  '8468', '8469',  '8472') |
			diag3 in ('7213', '72190', '72210','7222', '72252', '7226', 
					  '72280','72283', '72293', '72400', '72402','72403','7242', '7245',  '7246', '72470','72471', '72479',
					  '7384', '7385',  '7393',  '7384',  '7385', '7393', '7394', '75612', '8460', '8461', '8462',  '8463', 
					  '8468', '8469',  '8472')) &
			diag1 ~in('72142','72191', '72270', '72273', '7243', '7244') & /*Exclusion of radicular back pain*/
			diag2 ~in('72142','72191', '72270', '72273', '7243', '7244') &
			diag3 ~in('72142','72191', '72270', '72273', '7243', '7244') &
			pos in('11','22') then do; /*Only Office or Outpatient Hospitals*/

				lv_den=1;
				spine_inj_den=1;
				musculo_den=1;
				lv_den_s=1;
				spine_inj_den_s=1;
				musculo_den_s=1;
		end;

/*Imaging for plantar fasciitis*/
		/*Numerator*/
		if proc[i] in ('73620', '73630', '73650', '73718', '73719', '73720', '76880', '76881', '76882') &
		   (diag1 in ('72871', '7294') |
		    diag2 in ('72871', '7294') |
		    diag3 in ('72871', '7294')) then do;

			lv=lv+1;
			pf_image=1;
			musculo=musculo+1;
			lv_s=lv_s+1;
			pf_image_s=1;
			musculo_s=musculo_s+1;
		end;

		/*Denominator*/
		if (diag1 in ('72871', '7294') |
		    diag2 in ('72871', '7294') |
		    diag3 in ('72871', '7294')) then do;

			lv_den=1;
			pf_image_den=1;
			musculo_den=1;
			lv_den_s=1;
			pf_image_den_s=1;
			musculo_den_s=1;
		end;

/*Vertebroplasty*/
		/*Numerator*/
		if proc[i] in('22520','22521','22523','22524') then do;
			lv=lv+1;
			vertebro=1;
			musculo=musculo+1;
		end;

		/*Denominator*/
		   lv_den=1;
		   vertebro_den=1;
		   musculo_den=1;

		/*Specific Numerator*/
		if look_back=1 then do;
			if proc[i] in('22520','22521','22523','22524') & ost=1 &
			   diag1 ~in('1702','1985','20300','20301','20302','2132','22809','2380','2386','2392') &
			   diag2 ~in('1702','1985','20300','20301','20302','2132','22809','2380','2386','2392') &
		 	   diag3 ~in('1702','1985','20300','20301','20302','2132','22809','2380','2386','2392') then do;
			lv_s=lv_s+1;
			vertebro_s=1;
			musculo_s=musculo_s+1;
			end;

			/*Specific Denominator*/
			if ost=1 &
			   diag1 ~in('1702','1985','20300','20301','20302','2132','22809','2380','2386','2392') &
			   diag2 ~in('1702','1985','20300','20301','20302','2132','22809','2380','2386','2392') &
		 	   diag3 ~in('1702','1985','20300','20301','20302','2132','22809','2380','2386','2392') then do;
			lv_den_s=1;
			vertebro_den_s=1;
			musculo_den_s=1;
			end;
		end;

/*Arthroscopic Surgery*/
		/*Numerator*/
		if proc[i] in('29877','29879','G0289') then do;
			lv=lv+1;
			arthro=1;
			musculo=musculo+1;
		end;

		/*Denominator*/
		   lv_den=1;
		   arthro_den=1;
		   musculo_den=1;

		/*Specific Numerator*/
		if look_back=1 then do;
			if proc[i] in('29877','29879','G0289') & arth=1 &
			   diag1 ~in('8360','8361','8362','7170','71741') &
			   diag2 ~in('8360','8361','8362','7170','71741') &
			   diag3 ~in('8360','8361','8362','7170','71741') then do;
			lv_s=lv_s+1;
			arthro_s=1;
			musculo_s=musculo_s+1;
			end;

			/*Specific Denominator*/
			if arth=1 &
			   diag1 ~in('8360','8361','8362','7170','71741') &
			   diag2 ~in('8360','8361','8362','7170','71741') &
			   diag3 ~in('8360','8361','8362','7170','71741') then do;
			  lv_den_s=1;
			  arthro_den_s=1;
			  musculo_den_s=1;
			end;
		end;

/*****************************************************
 Preoperative Testing
*****************************************************/

/*Chest Radiography*/
		/*Numerator*/
		if proc[i] in('71010','71015','71020','71021','71022','71023','71030','71034','71035') & nc_surge=1 then do;
			lv=lv+1;
			chest_x=1;
			preoperative=preoperative+1;
		end;

		/*Denominator*/
		if nc_surge=1 then do;
			lv_den=1;
			chest_x_den=1;
			preoperative_den=1;
		end;

		/*Specific Numerator*/
		if proc[i] in('71010','71015','71020','71021','71022','71023','71030','71034','71035') & nc_surge=1 &
		   pos ~in(/*"UNK"*/"21","23","NONE")  then do;	/*Not in Unknown, Inpatient, or Emergency settings*/
			lv_s=lv_s+1;
			chest_x_s=1;
			preoperative_s=preoperative_s+1;
		end;

		/*Specific Denominator*/
		if nc_surge=1 &  pos ~in(/*"UNK"*/"21","23","NONE") then do;
			lv_den_s=1;
			chest_x_den_s=1;
			preoperative_den_s=1;
		end;

/*Echocardiography*/
		/*Numerator*/
		if proc[i] in('93303','93304','93306','93307','93308','93312','93315','93318') & nc_surge=1 then do;
			lv=lv+1;
			cardio_x=1;
			preoperative=preoperative+1;
		end;

		/*Denominator*/
		if nc_surge=1 then do;
			lv_den=1;
			cardio_x_den=1;
			preoperative_den=1;
		end;

		/*Specific Numerator*/
		if proc[i] in('93303','93304','93306','93307','93308','93312','93315','93318') & nc_surge=1 &
		   pos ~in(/*"UNK"*/"21","23","NONE")  then do;	/*Not in Unknown, Inpatient, or Emergency settings*/
			lv_s=lv_s+1;
			cardio_x_s=1;
			preoperative_s=preoperative_s+1;
		end;

		/*Specific Denominator*/
		if nc_surge=1 & pos ~in(/*"UNK"*/"21","23","NONE") then do;
			lv_den_s=1;
			cardio_x_den_s=1;
			preoperative_den_s=1;
		end;

/*PFT*/
		/*Numerator*/
		if proc[i] in('94010') & surge=1 then do;
			lv=lv+1;
			pft=1;
			preoperative=preoperative+1;
		end;

		/*Denominator*/
		if surge=1 then do;
			lv_den=1;
			pft_den=1;
			preoperative_den=1;
		end;

		/*Specific Numerator*/
		if proc[i] in('94010') & surge=1 & pos ~in(/*"UNK"*/"21","23","NONE") then do;	/*Not in Unknown, Inpatient, or Emergency settings*/
			lv_s=lv_s+1;
			pft_s=1;
			preoperative_s=preoperative_s+1;
		end;

		/*Specific Denominator*/
		if surge=1 & pos ~in(/*"UNK"*/"21","23","NONE") then do;
			lv_den_s=1;
			pft_den_s=1;
			preoperative_den_s=1;
		end;

/*Stress Testing*/
		/*Numerator*/
		if proc[i] in('78451','78452','78453','78454','78460','78461','78464','78465','78472',
					 '78473','78481','78483','78491','78492','93015','93016','93017','93018',
					 '93350','93351') & nc_surge=1 then do;
			lv=lv+1;
			stress=1;
			preoperative=preoperative+1;
		end;

		/*Denominator*/
		if nc_surge=1 then do;
			lv_den=1;
			stress_den=1;
			preoperative_den=1;
		end;

		/*Specific Numerator*/
		if proc[i] in('78451','78452','78453','78454','78460','78461','78464','78465','78472',
					 '78473','78481','78483','78491','78492','93015','93016','93017','93018',
					 '93350','93351') & nc_surge=1 & 
		   pos ~in(/*"UNK"*/"21","23","NONE") then do;	/*Not in Unknown, Inpatient, or Emergency settings*/
			lv_s=lv_s+1;
			stress_s=1;
			preoperative_s=preoperative_s+1;
		end;

		/*Specific Denominator*/
		if nc_surge=1 & pos ~in(/*"UNK"*/"21","23","NONE") then do;
			lv_den_s=1;
			stress_den_s=1;
			preoperative_den_s=1;
		end;

/*****************************************************
 Diagnostic and Preventive Testing
*****************************************************/

/*T3 Measurments in hypothyroidism*/
		/*Numerator*/
		if proc[i] in('84480','84481') & thyroid=1 then do;
			lv=lv+1;
			t3_test=1;
			diagnostic=diagnostic+1;
			lv_s=lv_s+1;
			t3_test_s=1;
			diagnostic_s=diagnostic_s+1;
		end;

		/*Denominator*/
		if thyroid=1 then do;
			lv_den=1;
			t3_test_den=1;
			diagnostic_den=1;
			lv_den_s=1;
			t3_test_den_s=1;
			diagnostic_den_s=1;
		end;

/*1,25 OH Vitamin D Testing*/
		/*Numerator*/
		if look_back>=1 then do;
			if proc[i] in ('82652') & CKD~=1 &

	           /*No evidence of sarcoidosis, TB, select neoplasms,hypercalcemia, secondary hyperparathyroidism of renal origin*/
			   diag1 ~in('27542', '58881','1890','1891','1830') & 
			   substr(diag1,1,3) ~in('135','173','174','175','188','200','201','202','203','204','205','206','207','208') & 
			   substr(diag1,1,2) ~in('01') &

			   diag2 ~in('27542', '58881','1890','1891','1830') & 
			   substr(diag2,1,3) ~in('135','173','174','175','188','200','201','202','203','204','205','206','207','208') & 
			   substr(diag2,1,2) ~in('01') &

			   diag3 ~in('27542', '58881','1890','1891','1830') & 
			   substr(diag3,1,3) ~in('135','173','174','175','188','200','201','202','203','204','205','206','207','208') & 
			   substr(diag3,1,2) ~in('01') then do;

			   lv=lv+1;
			   OH_vitamin=1;
			   diagnostic=diagnostic+1;
			   lv_s=lv_s+1;
			   OH_vitamin_s=1;
			   diagnostic_s=diagnostic_s+1;
			end;

			/*Denominator*/
			if CKD~=1 & /*No evidence of sarcoidosis, TB, select neoplasms,hypercalcemia, secondary hyperparathyroidism of renal origin*/
			   diag1 ~in('27542', '58881','1890','1891','1830') & 
			   substr(diag1,1,3) ~in('135','173','174','175','188','200','201','202','203','204','205','206','207','208') & 
			   substr(diag1,1,2) ~in('01') &

			   diag2 ~in('27542', '58881','1890','1891','1830') & 
			   substr(diag2,1,3) ~in('135','173','174','175','188','200','201','202','203','204','205','206','207','208') & 
			   substr(diag2,1,2) ~in('01') &

			   diag3 ~in('27542', '58881','1890','1891','1830') & 
			   substr(diag3,1,3) ~in('135','173','174','175','188','200','201','202','203','204','205','206','207','208') & 
			   substr(diag3,1,2) ~in('01') then do;

			   lv_den=1;
			   OH_vitamin_den=1;
			   diagnostic_den=1;
			   lv_den_s=1;
			   OH_vitamin_den_s=1;
			   diagnostic_den_s=1;
			end;
		end;

/*Vitamin D Screening*/
	/*Numerator*/
	if look_back>=1 then do;
		if proc[i] in('82306','82307','82562') & CKD~=1 & ost~=1  & /*No CKD, osteoporosis*/

			~('23600'<=:proc_cd<=:'23630' | '23665'<=:proc_cd<=:'23680' | '27230'<=:proc_cd<='27248') & /*No Hip or Humerus Fracture CPT*/

			diag1 ~in('58381', '58181','2504','V451', 'V4511', 'V4512','V778','278','8052', '8054', '8058', 
					  '73313','81400','81410','8134','8120') & 	/*No specific diabetes conditions, obesity, or certain frailities*/
				~(('81340'<=:diag1<=:'81354' | '81200'<=:diag1<=:'81219') & radiography=1) & /*No Wrist of Humerus Fracture ICD9, with radiography +/- 7 days*/
  				~('23600'<=:proc1<=:'23630' | '23665'<=:proc1<=:'23680' | '27230'<=:proc1<='27248') & /*No Hip or Humerus Fracture CPT*/
				substr(diag1,1,4)~='2780' & /*No Obesity*/

			diag2 ~in('58381', '58181','2504','V451', 'V4511', 'V4512','V778','278','8052', '8054', '8058', 
					  '73313','81400','81410','8134','8120') & 
				~(('81340'<=:diag2<=:'81354' | '81200'<=:diag2<=:'81219') & radiography=1) &
  				~('23600'<=:proc2<=:'23630' | '23665'<=:proc2<=:'23680' | '27230'<=:proc2<='27248') &
				 substr(diag2,1,4)~='2780' &

			diag3 ~in('58381', '58181','2504','V451', 'V4511', 'V4512','V778','278','8052', '8054', '8058', 
					  '73313','81400','81410','8134','8120') & 
				~(('81340'<=:diag3<=:'81354' | '81200'<=:diag3<=:'81219') & radiography=1) &
  				~('23600'<=:proc3<=:'23630' | '23665'<=:proc3<=:'23680' | '27230'<=:proc3<='27248') &
				substr(diag3,1,4)~='2780' then do;

			lv=lv+1;
			vit_d=1;
			diagnostic=diagnostic+1;
			*lv_s=lv_s+1;
			*vit_d_s=1;
			*new_s=new_s+1;
		end;

	/*Denominator*/
		if CKD~=1 & ost~=1  & /*No CKD, osteoporosis*/
			~('23600'<=:proc_cd<=:'23630' | '23665'<=:proc_cd<=:'23680' | '27230'<=:proc_cd<='27248') & /*No Hip or Humerus Fracture CPT*/

			diag1 ~in('58381', '58181','2504','V451', 'V4511', 'V4512','V778','278','8052', '8054', '8058', 
					  '73313','81400','81410','8134','8120') & 	/*No specific diabetes conditions, obesity, or certain frailities*/
				~(('81340'<=:diag1<=:'81354' | '81200'<=:diag1<=:'81219') & radiography=1) & /*No Wrist of Humerus Fracture ICD9, with radiography +/- 7 days*/
  				~('23600'<=:proc1<=:'23630' | '23665'<=:proc1<=:'23680' | '27230'<=:proc1<='27248') & /*No Hip or Humerus Fracture CPT*/
				substr(diag1,1,4)~='2780' & /*No Obesity*/

			diag2 ~in('58381', '58181','2504','V451', 'V4511', 'V4512','V778','278','8052', '8054', '8058', 
					  '73313','81400','81410','8134','8120') & 
				~(('81340'<=:diag2<=:'81354' | '81200'<=:diag2<=:'81219') & radiography=1) &
  				~('23600'<=:proc2<=:'23630' | '23665'<=:proc2<=:'23680' | '27230'<=:proc2<='27248') &
				 substr(diag2,1,4)~='2780' &

			diag3 ~in('58381', '58181','2504','V451', 'V4511', 'V4512','V778','278','8052', '8054', '8058', 
					  '73313','81400','81410','8134','8120') & 
				~(('81340'<=:diag3<=:'81354' | '81200'<=:diag3<=:'81219') & radiography=1) &
  				~('23600'<=:proc3<=:'23630' | '23665'<=:proc3<=:'23680' | '27230'<=:proc3<='27248') &
				substr(diag3,1,4)~='2780' then do;

			lv_den=1;
			vit_d_den=1;
			diagnostic_den=1;
			*lv_den_s=1;
			*vit_d_den_s=1;
			*new_den_s=1;
		end;
	end;

/*Annual Pap*/
		/*Numerator*/
		if look_back>=2 then do;
			if proc[i] in ('88141', '88142', '88143', '88147', '88148', '88150', '88152', '88153', '88154', 
						   '88164', '88165', '88166', '88167', '88174', '88175', 'G0123', 'G0124', 'G0141', 
						   'G0143', 'G0144', 'G0145', 'G0147', 'G0148', 'P3000', 'Q0091') & 
			   upcase(gdr_cd)='F' & 30<=age<=65 & prepap>=2 then do;
				lv=lv+1;
				pap=1;
				diagnostic=diagnostic+1;
				*lv_s=lv_s+1;
				*pap_s=1;
				*new_s=new_s+1;
			end;


		/*Denominator*/
			if upcase(gdr_cd)='F' & 30<=age<=65 then do;
				lv_den=1;
				pap_den=1;
				diagnostic_den=1;
				*lv_den_s=1;
				*pap_den_s=1;
				*new_den_s=1;
			end;
		end;

/*Adnexal Cyst Imaging*/
		/*Numerator*/
		if look_back>=1 then do;
			if proc[i] in ('76857','76830') & precyst>=2 &
			   (diag1 in('6200', '6201', '6202') |
			    diag2 in('6200', '6201', '6202') |
			    diag3 in('6200', '6201', '6202')) then do;

				lv=lv+1;
				cyst=1;
				diagnostic=diagnostic+1;
				lv_s=lv_s+1;
				cyst_s=1;
				diagnostic_s=diagnostic_s+1;
			end;

		/*Denominator*/
			if (diag1 in('6200', '6201', '6202') |
		   		diag2 in('6200', '6201', '6202') |
		    	diag3 in('6200', '6201', '6202')) then do;

				lv_den=1;
				cyst_den=1;
				diagnostic_den=1;
				lv_den_s=1;
				cyst_den_s=1;
				diagnostic_den_s=1;

			end;
		end;

/*HPV testing in women < 30*/
		/*Numerator*/
		if proc[i] in('87622','87620','90649','87621','90650') & upcase(gdr_cd)='F' & age<30 then do;
			lv=lv+1;
			hpv=1;
			diagnostic=diagnostic+1;
			lv_s=lv_s+1;
			hpv_s=1;
			diagnostic_s=diagnostic_s+1;
		end;

		/*Denominator*/
		if upcase(gdr_cd)='F' & age<30 then do;
			lv_den=1;
			hpv_den=1;
			diagnostic_den=1;
			lv_den_s=1;
			hpv_den_s=1;
			diagnostic_den_s=1;
		end;

/*PTH Measurements*/
		/*Numerator*/
		if look_back >= 1 then do;
			if proc[i] in('83970') & CKD=1 then do;
				lv=lv+1;
				pth=1;
				diagnostic=diagnostic+1;
			end;

		/*Denominator*/
			if CKD=1 then do;
				lv_den=1;
				pth_den=1;
				diagnostic_den=1;
			end;

		/*Specific Numerator*/
			if proc[i] in('83970') & CKD=1 & dialysis~=1 & post_dialysis~=1 & hyp_cal~=1 then do;
				lv_s=lv_s+1;
				pth_s=1;
				diagnostic_s=diagnostic_s+1;
			end;

		/*Specific Denominator*/
			if CKD=1 & dialysis~=1 & post_dialysis~=1 & hyp_cal~=1 then do;
				lv_den_s=1;
				pth_den_s=1;
				diagnostic_den_s=1;
			end;
		end;

/*Homocysteine*/
		/*Numerator*/
		if proc[i] in('83090') then do;
			lv=lv+1;
			homoc=1;
			diagnostic=diagnostic+1;
		end;

		/*Denominator*/
			lv_den=1;
			homoc_den=1;
			diagnostic_den=1;

		/*Specific Numerator*/
	if look_back >= 1 then do;
		if proc[i] in('83090') & b12_folate~=1 then do;
			lv_s=lv_s+1;
			homoc_s=1;
			diagnostic_s=diagnostic_s+1;
		end;

		/*Specific Denominator*/
		if b12_folate~=1 then do;
			lv_den_s=1;
			homoc_den_s=1;
			diagnostic_den_s=1;
		end;
	end;

/*Hypercoagulability*/
	/*Numerator*/
	if look_back >= 1 then do;
		if proc[i] in('83090','85300','85303','85306','85613','86147') & dvt_pe=1 then do;
			lv=lv+1;
			coag=1;
			diagnostic=diagnostic+1;
		end;

		/*Denominator*/
		if dvt_pe=1 then do;
			lv_den=1;
			coag_den=1;
			diagnostic_den=1;
		end;

		/*Specific Numerator*/
		if proc[i] in('83090','85300','85303','85306','85613','86147') & dvt_pe=1 & rec_dvt_pe~=1 then do;
			lv_s=lv_s+1;
			coag_s=1;
			diagnostic_s=diagnostic_s+1;
		end;
		/*Specific Denominator*/
		if dvt_pe=1 & rec_dvt_pe~=1 then do;
			lv_den_s=1;
			coag_den_s=1;
			diagnostic_den_s=1;
		end;
	end;

/*Close the Loop*/
end;

		
/*If a patient is ineligible bc of enrollment deficiencies (defined in low_qual_build.sas) set their flag to missing or 0*/
	%macro inelig;
		%do j=2011 %to 2013;
			if year=&j. and elig_&j.~=1 then do;
				lv=0;
				lv_s=0;
				cancer=0;
				cancer_s=0;
				neuro=0;
				neuro_s=0;
				diagnostic=0;
				diagnostic_s=0;
				preoperative=0;
				preoperative_s=0;
				cardio=0;
				cardio_s=0;
				musculo=0;
				musculo_s=0;

				lv_bone=.;
				homoc=.;
				coag=.;
				pth=.;
				chest_x=.;
				cardio_x=.;
				pft=.; 
				stress=.;
				ct_sinus=.;
				scan_sync=.;
				scan_head=.;
				eeg_head=.;
				back=.;
				carotid_scan_asymp=.;
				carotid_scan_sync=.;
				cardio_stress=.;
				coronary=.;
				renal_angio=.;
				carotid_end=.;
				ivc=.;
				vertebro=.;
				arthro=.;
				neuro=.;
				diagnostic=.;
				preoperative=.;
				musculo=.;
				cardio=.;
				lv=.;
				t3_test=.;
				spine_inj=.;
				pf_image=.;
				OH_vitamin=.;
				vit_d=.;
				pap=.;
				cyst=.;
				hpv=.;

				lv_bone_den=.;
				homoc_den=.;
				coag_den=.;
				pth_den=.;
				chest_x_den=.;
				cardio_x_den=.;
				pft_den=.; 
				stress_den=.;
				ct_sinus_den=.;
				scan_sync_den=.;
				scan_head_den=.;
				eeg_head_den=.;
				back_den=.;
				carotid_scan_asymp_den=.;
				carotid_scan_sync_den=.;
				cardio_stress_den=.;
				coronary_den=.;
				renal_angio_den=.;
				carotid_end_den=.;
				ivc_den=.;
				vertebro_den=.;
				arthro_den=.;
				neuro_den=.;
				diagnostic_den=.;
				preoperative_den=.;
				musculo_den=.;
				cardio_den=.;
				lv_den=.;
				t3_test_den=.;
				spine_inj_den=.;
				pf_image_den=.;
				OH_vitamin_den=.;
				vit_d=.;
				pap_den=.;
				cyst_den=.;
				hpv_den=.;

				lv_bone_s=.;
				homoc_s=.;
				coag_s=.;
				pth_s=.;
				chest_x_s=.;
				cardio_x_s=.;
				pft_s=.; 
				stress_s=.;
				ct_sinus_s=.;
				scan_sync_s=.;
				scan_head_s=.;
				eeg_head_s=.;
				back_s=.;
				carotid_scan_asymp_s=.;
				carotid_scan_sync_s=.;
				cardio_stress_s=.;
				coronary_s=.;
				renal_angio_s=.;
				carotid_end_s=.;
				ivc_s=.;
				vertebro_s=.;
				arthro_s=.;
				neuro_s=.;
				diagnostic_s=.;
				preoperative_s=.;
				musculo_s=.;
				cardio_s=.;
				lv_s=.;
				t3_test_s=.;
				spine_inj_s=.;
				pf_image_s=.;
				OH_vitamin_s=.;
				*vit_d_s=.;
				*pap_s=.;
				cyst_s=.;
				hpv_s=.;

				lv_bone_den_s=.;
				homoc_den_s=.;
				coag_den_s=.;
				pth_den_s=.;
				chest_x_den_s=.;
				cardio_x_den_s=.;
				pft_den_s=.; 
				stress_den_s=.;
				ct_sinus_den_s=.;
				scan_sync_den_s=.;
				scan_head_den_s=.;
				eeg_head_den_s=.;
				back_den_s=.;
				carotid_scan_asymp_den_s=.;
				carotid_scan_sync_den_s=.;
				cardio_stress_den_s=.;
				coronary_den_s=.;
				renal_angio_den_s=.;
				carotid_end_den_s=.;
				ivc_den_s=.;
				vertebro_den_s=.;
				arthro_den_s=.;
				neuro_den_s=.;
				diagnostic_den_s=.;
				preoperative_den_s=.;
				musculo_den_s=.;
				cardio_den_s=.;
				lv_den_s=.;
				t3_test_den_s=.;
				spine_inj_den_s=.;
				pf_image_den_s=.;
				OH_vitamin_den_s=.;
				*vit_d_den_s=.;
				*pap_den_s=.;
				cyst_den_s=.;
				hpv_den_s=.;
			end;
		%end;
	%mend;
	%inelig;

	if ami_all=1 & (cardio_stress=1 | coronary=1) then time_ami=Fst_Dt-first_ami_dt;
	if ihd_all=1 & (cardio_stress=1 | coronary=1) then time_ihd=Fst_Dt-first_ihd_dt;
run;

proc freq data=out.low_value_procs2;
	tables coronary_s cardio_stress_s pos ed_stay*cardio_stress ed14*cardio_stress pos*cardio_stress ami*cardio_stress;
run;

proc univariate data=out.low_value_procs2;
	var time_ami time_ihd;
	where coronary=1;
run;

proc univariate data=out.low_value_procs2;
	var time_ami time_ihd;
	where cardio_stress=1;
run;


